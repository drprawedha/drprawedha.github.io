<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Work Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      display: flex;
      flex-direction: row;
      gap: 20px;
    }

    #calendarContainer {
      flex: 3;
    }

    #upcomingTasks {
      flex: 1;
      border-left: 1px solid #ddd;
      padding-left: 20px;
    }

    #calendar { max-width: 100%; }

    #searchBox {
      max-width: 600px;
      margin: 10px 0;
      display: flex;
      gap: 10px;
    }

    #searchInput {
      flex: 1;
      padding: 8px;
      font-size: 1rem;
    }

    #searchResult {
      margin-top: 10px;
    }

    .modal {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 9999;
      display: none;
    }

    .modal h3 { margin-top: 0; }

    .close {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 18px;
      cursor: pointer;
      color: #999;
    }

    .close:hover { color: red; }

    .fc-event {
      background-color: #2196F3;
      border: none;
      font-size: 0.75em;
      padding: 2px;
    }

    ul { padding-left: 20px; }
  </style>
</head>
<body>

<div id="calendarContainer">
  <h2>üìÖ Work History Calendar</h2>

  <!-- Search Menu -->
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="Search work history (e.g., 'firmware', 'meeting')">
    <button onclick="searchData()">üîç Search</button>
  </div>

  <!-- Calendar -->
  <div id="calendar"></div>

  <!-- Search Result -->
  <div id="searchResult"></div>
</div>

<!-- Upcoming Task Sidebar -->
<div id="upcomingTasks">
  <h3>üìå Upcoming Tasks (Next 3 Days)</h3>
  <div id="upcomingList">
    <p>Loading tasks...</p>
  </div>
</div>

<!-- Modal -->
<div id="historyModal" class="modal">
  <span class="close" onclick="closeModal()">&times;</span>
  <h3>Work History Details</h3>
  <div id="historyContent"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
  let pekerjaanData = {};

  document.addEventListener('DOMContentLoaded', function () {
    fetch('pekerjaan.json')
      .then(response => response.json())
      .then(data => {
        pekerjaanData = data;
        renderCalendar(data);
        renderUpcoming(data);
      })
      .catch(error => {
        console.error('Failed to load pekerjaan.json:', error);
        document.getElementById('calendar').innerHTML = '<p style="color:red;">Failed to load work data.</p>';
        document.getElementById('upcomingList').innerHTML = '<p style="color:red;">Unable to show upcoming tasks.</p>';
      });
  });

  function renderCalendar(data) {
    const pekerjaanEvents = Object.keys(data).map(date => ({
      title: `üìå ${data[date].length} task(s)`,
      start: date,
      allDay: true
    }));

    const calendarEl = document.getElementById('calendar');
    const modal = document.getElementById('historyModal');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      },
      events: pekerjaanEvents,
      dateClick: function (info) {
        const date = info.dateStr;
        const history = data[date] || ['No recorded tasks'];
        showModal(history, date);
      }
    });

    calendar.render();

    document.addEventListener('click', function (event) {
      const isClickInside = modal.contains(event.target);
      if (!isClickInside && modal.style.display === 'block') {
        closeModal();
      }
    });
  }

  function showModal(historyList, date) {
    const modal = document.getElementById('historyModal');
    const content = document.getElementById('historyContent');
    content.innerHTML = `<strong>${date}</strong><ul>` + historyList.map(item => `<li>${item}</li>`).join('') + '</ul>';
    modal.style.display = 'block';
  }

  function closeModal() {
    document.getElementById('historyModal').style.display = 'none';
  }

  function searchData() {
    const keyword = document.getElementById('searchInput').value.toLowerCase();
    const resultDiv = document.getElementById('searchResult');
    resultDiv.innerHTML = '';

    if (!keyword) {
      resultDiv.innerHTML = '<p>Please enter a keyword to search.</p>';
      return;
    }

    let resultHTML = '';
    let found = false;

    for (const [date, tasks] of Object.entries(pekerjaanData)) {
      const filteredTasks = tasks.filter(task => task.toLowerCase().includes(keyword));
      if (filteredTasks.length > 0) {
        found = true;
        resultHTML += `<h4>${date}</h4><ul>${filteredTasks.map(task => `<li>${task}</li>`).join('')}</ul>`;
      }
    }

    resultDiv.innerHTML = found ? resultHTML : '<p>No matching work found.</p>';
  }

  function renderUpcoming(data) {
    const upcomingDiv = document.getElementById('upcomingList');
    const today = new Date();

    let output = '';
    let found = false;

    for (let i = 0; i < 3; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dateStr = date.toISOString().split('T')[0];

      if (data[dateStr]) {
        found = true;
        output += `<h4>${dateStr}</h4><ul>${data[dateStr].map(task => `<li>${task}</li>`).join('')}</ul>`;
      }
    }

    upcomingDiv.innerHTML = found ? output : '<p>No tasks for the next 3 days.</p>';
  }
</script>

</body>
</html>
